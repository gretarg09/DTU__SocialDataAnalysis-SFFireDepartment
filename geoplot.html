<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>San Francisco fire department</title>
        <script type="text/javascript" src="d3/d3.js"></script>
        <script type="text/javascript" src="d3/d3-tip/index.js"></script>
        <link rel="stylesheet" href="style/myStyle.css">
        <link rel="stylesheet" href="style/normalize.css">
        <link rel="stylesheet" href="style/skeleton.css">
    </head>
    <body>
        <h1 >Fire Department Calls for Service</h1>
        <div class='container'>
            <div class='row'>
                <div class='twelve columns exercise-view'>
                    <h4 >Analyses of the response time of the San Francisco fire department </h4>

                    <div class="visual-container"> 
                        <div class='visual-buttons'> 
                            <a href="index.html"> <button id="page1_btn" class="visual-button banner-btns">Introduction</button></a>
                            <a href="responsetime.html"> <button id="page2_btn" class="visual-button banner-btns">Response time</button></a>
                            <a href="geoplot.html"><button id="page3_btn" class="visual-button page_button_chosen banner-btns">Geo plot</button></a>
                            <a href="machinelearning.html"><button id="page4_btn" class="visual-button banner-btns">Machine learning</button></a>
                        </div>
                    <div id="Visualization1_text">
                </div>
            </div>


            <div class='row'>
                <div class='twelve columns exercise-view'>

                    <h2>Responsive geoplot</h2>

                    <div id="Visualization1_text">
                        <p>
                            
                        </p>
                        <p>
                            In this responsive geo plot the difference in response time between neighborhoods in San Francisco is visualized. Each neighborhood is colored based on one of the following measures; neighborhood's average response time, average distance to responding fire station, ratio of late response time or ratio of critically late response time. Here, like in the previous section, late response time is defined as more than 10 minutes and critically late response time is defined as more than 20 minutes. On the left side of the geo plot you can see what each color corresponds to. 

                        </p>
                        <p>
                            On the right side of the geo plot a stack histogram of the response time distribution can be found. It shows the ratio of acceptable response times, late response times and critically late response times.

                            <!-- You can get the response time distribution for each neighborhood by clicking on the neighborhood in the geo plot and you can see how it has evolved over the years by toggling the period buttons.-->
                        </p>
                        <p>
                            Below the geo plot is a responsive histogram where you can find the average response time for each hour of the day. 

                            <!--You can change the values of the histogram by choosing a neighborhood or by toggling the period buttons.-->
                        </p>
                        <p>
                            By hovering over the geo plot you can get further information about each neighborhood. You can select the neighborhood by pressing on it, when chosen the neighborhood will fade in and out. When you have chosen the neighborhood the stacked histogram on the right site and the "hour of the day" histogram under the geo plot will render information about the chosen neighborhood. You can then toggle the periods button to see how the values have changed over the years. You can un select the neighborhood by pressing on it again.
                        </p>

                        <p>
                            Each fire station in San Francisco can also been seen in the geo plot. By hovering over the station you can see the station's address and what battalion it belongs to.
                        </p>

                        <p>
                            Please feel free to spend as much time as you want playing around with this visualization. There is alot to see here.
                        </p> 
                        </br>
                    </div>

                    <div class='visual-buttons'> 
                            <button id="geo_button1" class="button_geo button_geo1 visual-button">Average response time</button>
                            <button id="geo_button2" class="button_geo button_geo1 visual-button">Average distance to responding fire station</button>
                            <button id="geo_button3" class="button_geo button_geo1 visual-button">Ratio of late response time </button>
                            <button id="geo_button4" class="button_geo button_geo1 visual-button">Ratio of critically late response time </button>
                    </div>
                </div>
            </div>

            <div class='row'>
                <div class='overlapping twelve columns exercise-view'>
                     
                    <div style="text-align:left; margin-bottom:0">
                        <div class="color-scale-div">
                            <svg width="30" height="20" > 
                                <rect x="0" y="0" width="20" height="20" fill="rgba(208,85,75,1)" stroke="rgba(128, 128, 128, 1.0)" stroke-width="1"/>
                            </svg>
                             <text y="10" class="color-scale-span" id="scale_text1"> Avg. response time >= 8 min </text>
                        </div>

                        <div class="color-scale-div">
                            <svg width="30" height="20" > 
                                <rect x="0" y="0" width="20" height="20" fill="rgba(226,153,147,1)" stroke="rgba(128, 128, 128, 1)" stroke-width="1"/>
                            </svg>

                             <text class="color-scale-span" id="scale_text2"> 7 min =< Avg. response time < 8 min</text>
                        </div>

                        <div class="color-scale-div">
                            <svg width="30" height="20" > 
                                <rect x="0" y="0" width="20" height="20" fill="rgba(226,234,154,1)" stroke="rgba(128, 128, 128, 1)" stroke-width="1"/>
                            </svg>

                             <text class="color-scale-span" id="scale_text3"> 6 min =< Avg. response time < 7 min </text>
                        </div>

                        <div class="color-scale-div">
                            <svg width="30" height="20" > 
                                <rect x="0" y="0" width="20" height="20" fill="rgba(242,246,211,1)" stroke="rgba(128, 128, 128, 1)" stroke-width="1"/>
                            </svg>

                             <text class="color-scale-span" id="scale_text4"> Avg. response time < 6 min </text>
                        </div>
                    </div>
                </div>

               <div class='overlapping twelve columns exercise-view'>

                    <div class="overlapping2">
                        <span id="h2_neighborhood">Responsive geoplot</span>
                    </div>

                </div>


                <div class='twelve columns exercise-view'>
                    <div class="visual-container"> 
                        <div class="row">
                            <div class="ten columns">
                                <div id="area1"></div>   
                            </div>
                            <div class="two columns" style="z-index=1000">
                                <div  id="area1_stack"></div>   
                            </div>
                        </div>


                        <div class='visual-buttons'> 
                            <button id="y2012" class="button_geo button_geo2 visual-button">2012</button>
                            <button id="y2013" class="button_geo button_geo2 visual-button">2013</button>
                            <button id="y2014" class="button_geo button_geo2 visual-button">2014</button>
                            <button id="y2015" class="button_geo button_geo2 visual-button">2015</button>
                            <button id="y2016" class="button_geo button_geo2 visual-button">2016</button>
                            <button id="yoverall" class="button_geo button_geo2 visual-button">All</button>
                        </div>

                         <div id="area1_histo"></div> 


                        <div id="Visualization1_text" class="geoplot_result_text">

                        <h5>Some thoughts</h5>

                        <ul>
                                <li>
                                    interesting thing 1
                                </li>
                                <li>
                                    interesting thing 2
                                </li>
                                <li>
                                    interesting thing 3
                                </li>
                            </ul> 
                        </div>

                    </div>
                </div>
            </div>
        </div> 

        <script type="text/javascript">
            // GEOPLOT AND HOURLY HISTOGRAM 
            //var primaryColor = "rgba(135,206,235,1)"
            var primaryColor = "rgba(208,85,75,1)";
            var secondaryColor = "rgba(226,153,147,1)";
            var moreinfoTextColor = "rgba(255,255,255)";

            var fire_stations;
            var neighborhoods_statistic;

            var neighborhood_map_data;
            var neighborhood_map_data_overall;

            var neighborhood_late_ratio;
            var neighborhood_verylate_ratio

            var geojson;

            var late_arrivals;

            var geo_button_chosen = "geo_button1";
            var geo_button_year_chosen = "yoverall";

            var neighborhood_chosen_index = -1;

            setcolor_button(geo_button_chosen,1);
            setcolor_button(geo_button_year_chosen,2);

            //var map_color = ["rgba(230,230,230,1)", "rgba(255,69,0, 0.4)", "rgba(255,69,0, 0.6)","rgba(255,69,0,0.8)"]
            //var map_color = ["rgba(230,230,230,1)", "rgba(179,179,179,1)", "rgba(153,153,153,1)","rgba(128,128,128,1)"]


            // GEO PLOT SETUP
            //Yellow to red map color
            var map_color = ["rgba(242,246,211,1)","rgba(226,234,154,1)", "rgba(226,153,147,1)","rgba(208,85,75,1)"];

            var w = 960,
                h = 600;

            var projection = d3.geo.mercator()
                .center([-122.433701, 37.767683])
                .scale(200000)
                .translate([w / 2, h / 2]);

            var path = d3.geo.path()
                .projection(projection);

            //Create SVG element
            var svg = d3.select("#area1")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

            // Create tip for the neighborhoods in the map
            var tip_neighborhoods = d3.tip()
              .attr('class', 'd3-tip')
              .offset([0,0])
              .html(function(d,i) {
                    if(i == 41){
                        i = neighborhood_chosen_index;
                    }
                    return get_additional_info_for_neighborhood(d,i)
                });


            svg.call(tip_neighborhoods);  

            // Create tip for each station
            var tip_firestations = d3.tip()
              .attr('class', 'd3-tip')
              .offset([-20,0])
              .html(function(d) {
                return "<div style='margin-bottom: 6px'><strong style='margin-right: 6px'>" + "STATION " + d['station'] + "</strong></div>"
                                + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + d['location'] + "</span></div>"
                                + "<div><span class='tipperCol' >" + d['battalion'] + "</span></div>";;
              });
            svg.call(tip_firestations);  


            // HISTOGRAM SETUP
            // create histogram for each hour
            var margin = {top: 40, right: 20, bottom: 50, left: 60},
            width = 960 - margin.left - margin.right,
            height = 250 - margin.top - margin.bottom;

            var xScale = d3.scale.ordinal()
                .domain(["0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23"])
                .rangeRoundBands([0, width], .1);

            var yScale = d3.scale.linear()
                .domain([0, 1000])
                .range([height, 0]);
                
            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left")
              //.tickFormat(formatPercent);

            var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-20, 0])
                .html(function(d,i) {
                    return "<div style='margin: 0px 0px 15px 0px; text-align:center';><strong style='margin-right: 6px'>" + "Hour: " + i +  "</strong></div>"

                        + "<div style='margin-bottom: 6px '><span class='tipperCol' >" + "Average response time:" + "</span></strong> <span style='color:"+ secondaryColor + "'>"+ minutes_from_seconds(d) + " (" + Math.round(d) + " sek)"+ "</div>";
                })
            
            var svg1_histo = d3.select("#area1_histo")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            svg1_histo.append("text")
                .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                .attr("transform", "translate("+ (width/2) +","+ (height + margin.bottom - 3) +")")  // centre below axis
                .text("Response time per hour of the day");

            svg1_histo.call(tip);

            // STACK LAYOUT SETUP
            //var colors_stack = ["rgba(242,246,211,1)","rgba(226,234,154,1)", "rgba(226,153,147,1)","rgba(208,85,75,1)"];
            var colors_stack = ["rgba(226,234,154,1)","rgba(226,153,147,1)","rgba(208,85,75,1)"];

            var data_stack = [
                {steps: 'Response t. distribution', A: 1, B: 0, C: 0},
            ];
             
            var xData = ["A", "B", "C"];
             
            var width_stack = 140 - margin.left - margin.right;
            var height_stack = 380 - margin.top - margin.bottom;
            var margin_stack = {top: h-height_stack-45, right: 50, bottom: 30, left: 50};
             
            var x_stack = d3.scale.ordinal()
                    .rangeRoundBands([0, width_stack], .35);
             
            var y_stack = d3.scale.linear()
                    .rangeRound([height_stack, 0]);
             
            //var color = d3.scale.category20();
             
            var xAxis_stack = d3.svg.axis()
                    .scale(x_stack)
                    .orient("bottom");
             
            var svg_stack = d3.select("#area1_stack")
                    .append("svg")
                    .attr("width", width_stack + margin_stack.left + margin_stack.right)
                    .attr("height", height_stack + margin_stack.top + margin_stack.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin_stack.left + "," + margin_stack.top + ")");

            var tip_stack = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-20, 0])
                .html(function(d,i) {
                    return "<p>"+ Math.round(d.y*100)+ "%" +"</p>";
                });
                
            svg_stack.call(tip_stack);
             
            var dataIntermediate = xData.map(function (c) {
                return data_stack.map(function (d) {
                    return {x: d.steps, y: d[c]};
                });
            });
             
            var dataStackLayout = d3.layout.stack()(dataIntermediate);
             
            x_stack.domain(dataStackLayout[0].map(function (d) {
                return d.x;
            }));
             
            y_stack.domain([0,
                d3.max(dataStackLayout[dataStackLayout.length - 1],
                        function (d) { return d.y0 + d.y;})
                ])
              .nice();
             
            var layer = svg_stack.selectAll(".stack")
                    .data(dataStackLayout)
                    .enter().append("g")
                    .attr("class", "stack")
                    .style("fill", function (d, i) {
                        return colors_stack[i];
                    });
             
            layer.selectAll("rect")
                    .data(function (d) {
                        return d;
                    })
                    .enter().append("rect")
                    .attr("x", function (d) {
                        return x_stack(d.x);
                    })
                    .attr("y", function (d) {
                        return y_stack(d.y + d.y0);
                    })
                    .attr("height", function (d) {
                        return y_stack(d.y0) - y_stack(d.y + d.y0);
                    })
                    .attr("width", x_stack.rangeBand())
                    .on('mouseover', tip_stack.show)
                    .on('mouseout', tip_stack.hide);
             
            svg_stack.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + height_stack + ")")
                    .call(xAxis_stack);

            
            svg_stack.selectAll("text")
                .data(dataStackLayout)
                .enter()
                .append("text")
                .attr("class","stack-layout-text")
                .text(function(d,i) {
                    var total_percentage;
                    if(i==1){
                        total_percentage = data_stack[0]["A"];
                    }
                    else{
                        total_percentage = data_stack[0]["A"] + data_stack[0]["B"];
                    }

                    return "--" + total_percentage * 100 + "%";
                })
                .attr("x", function(d,i) {
                    return width_stack - 10;
                })
                .attr("y", function(d,i) {
                    var text_y = y_stack(d[0].y0) 
                    return text_y;
                })
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("fill", "#000000");

            // Draw legend
            var legend = svg.selectAll(".legend")
              .data(colors_stack)
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(" + -65 + "," + (h-height_stack - 120 + (i * 19)) + ")"; });
             
            legend.append("rect")
              .attr("x", width - 18)
              .attr("width", 18)
              .attr("height", 18)
              .style("fill", function(d, i) {return colors_stack.slice().reverse()[i];});
             
            legend.append("text")
              .attr("x", width + 5)
              .attr("y", 18/2)
              .attr("dy", ".35em")
              .attr("class","color-scale-text")
              .style("text-anchor", "start")
              .text(function(d, i) { 
                switch (i) {
                  case 0: return "% of critically late response t.";
                  case 1: return "% of late response t.";
                  case 2: return "% of acceptable response t.";
                }
              });

            // READING IN DATA
            d3.json("Notebook/Data/response_time_groups_nltfree.json", function(error,json) {
                if (error) {  //If error is not null, something went wrong.
                    console.log(error);  //Log the error.
                } 
                else {  
                    neighborhood_map_data_overall = json;
                    update_data();
                    update_neighborhood(neighborhood_chosen_index);

                    create_hourly_histogram();

                    // We call update on these graphs to initialize the data
                    update_stack_histogram();
                    update_hourly_histogram();

                    //Load in GeoJSON data
                    d3.json("Notebook/Data/Analysis Neighborhoods.geojson", function(json){
                        //Bind data and create one path per GeoJSON feature
                        geojson = json;
                        createSFPDmap(json);

                        d3.json("Notebook/Data/fire_station.json", function(error,json) {
                            if (error) {  //If error is not null, something went wronsg.
                                console.log(error);  //Log the error.
                            } 
                            else {  
                                console.log(json);
                                fire_stations = json;
                                create_FireStation_circles(fire_stations);
                            }   
                        });

                        d3.json("Notebook/Data/neighborhood_info.json", function(error,json) {
                            if (error) {  //If error is not null, something went wrong.
                                console.log(error);  //Log the error.
                            } 
                            else {  
                                neighborhoods_statistic = json;
                            }   
                        });

                        // p button click event handler
                        d3.selectAll("button")
                            .filter(".button_geo1")
                            .on("click", function() {

                                // Set color on kmeans_p
                                var button_ID = d3.select(this).attr("id");
                                geo_button_chosen = button_ID

                                setcolor_button(button_ID,1);

                                //update_geo_when_clicked();
                                update_geo();
                                update_scale_txt();
                            });

                        d3.selectAll("button")
                            .filter(".button_geo2")
                            .on("click", function() {

                                // Set color on kmeans_p
                                var button_ID = d3.select(this).attr("id");
                                geo_button_year_chosen = button_ID;
                                setcolor_button(button_ID,2);

                                update_data();
                                update_geo();
                                //update_geo_when_clicked();
                                update_scale_txt();
                                update_hourly_histogram();
                                update_stack_histogram();

                                //update_geo();
                                //update_scale_txt();
                            });

                    });
                }   
            });
            // The function returns longitute latitute value pairs
            function get_lonlat_pair(d,i){
                var lat = d["lat"];
                var lon = d["lon"];
                
                return [lon,lat];
            }

            // Create the SFPD map from geojson data
            function createSFPDmap(json_data) {
                //Load in GeoJSON data
                //Bind data and create one path per GeoJSON feature
                svg.selectAll("path")
                    .data(json_data.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .on('mouseover', tip_neighborhoods.show)
                    .on("click", function(d,i){
                        if(i == 41){
                            remove_extra_feature_geo();
                            //update_neighborhood(neighborhood_chosen_index);
                        }
                        else{
                            update_neighborhood(i);
                        }
                        update_geo_when_clicked();
                        update_hourly_histogram();
                        update_stack_histogram();
                        //update_geo();
                    })
                    .on('mouseout', tip_neighborhoods.hide)
                    .attr('stroke-width', function(d,i){
                        if(i == 41){
                            return 1;
                        }
                        else {
                            return 0.6;
                        }
                    })
                    .attr('stroke',function(d,i){
                        if(i == 41){
                            //return primaryColor;
                            return "#000000";
                        }
                        else {
                            return "#626262";
                        }
                    })
                    .attr('fill', function(d,i){
                        if(i == 41){
                            return getColor_district(neighborhood_chosen_index);
                        }
                        else{
                            return getColor_district(i);
                        }
                    })
                    .attr('class','mapDistrict');
            }

            // updating geoplot based on what button is chosen
            function update_geo(){
                var paths =  svg.selectAll("Path")
                paths.attr('fill', function(d,i){
                        if(i == 41){
                            return getColor_district(neighborhood_chosen_index);
                        }
                        else if (i==neighborhood_chosen_index){
                           return "rgba(255,255,255,0.8)";
                        }
                        else{
                            return getColor_district(i);
                        }
                    });
            }

            function remove_extra_feature_geo(){
                // first we remove the previouse chosen hood
                if(geojson.features.length > 41){
                    geojson.features.pop();
                }

                // We remove the paths for previouse chosen hood
                var paths = svg.selectAll("path")
                    .data(geojson.features)
                paths.exit()
                    .remove();
            }

            function update_geo_when_clicked(){
                remove_extra_feature_geo();

                // Get the chosen neighborhood's feature
                var feature = geojson.features[neighborhood_chosen_index];
                geojson.features.push(feature);   

                // Update the geograph
                svg.selectAll("path")
                    .data(geojson.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .on('mouseover', tip_neighborhoods.show)
                    .on("click", function(d,i){
                        if(i == 41){
                            remove_extra_feature_geo();
                            update_neighborhood(-1);
                            update_geo();
                        }
                        else{
                            update_neighborhood(i);
                            update_geo_when_clicked();
                        }

                        update_stack_histogram();
                        update_hourly_histogram();
                        update_stack_histogram();

                        //update_geo();
                    })
                    .on('mouseout', tip_neighborhoods.hide)
                    .attr('stroke-width', function(d,i){
                        if(i == 41){
                            return 1;
                        }
                        else {
                            return 0.6;
                        }
                    })
                    .attr('stroke',function(d,i){
                        if(i == 41){
                            //return primaryColor;
                            return "#000000";
                        }
                        else {
                            return "#626262";
                        }
                    })
                    .attr('fill', function(d,i){
                        if(i == 41){
                            //return getColor_district(neighborhood_chosen_index);
                            return "rgba(255,255,255,0.8)";
                        }
                        else{
                            return getColor_district(i);
                        }
                    })
                    .attr('class','mapDistrict')
                    .attr('id','active');

                //We need to delete the firestatio circles and the corresponding text and creating them again.
                delete_FireStation_circles();
                create_FireStation_circles(fire_stations);

                // We also need to recolor the district that was chosen earlier
                update_geo();
            }

            // Delete fire station circles
            function delete_FireStation_circles()
            {
                var circle = svg.selectAll("circle")
                    .data([]);   

                var text = svg.selectAll("text")
                    .filter(".labels")
                    .data([]);

                circle.exit()
                    .remove();

                text.exit()
                    .remove();
            }


            // create the fire station circles
            function create_FireStation_circles(fire_stations_data) {
                    //Create circles for each observation
                    var circle_radius = 6;

                    svg.selectAll("circle")
                        .data(fire_stations_data)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d,i) { return projection(get_lonlat_pair(d,i))[0];})
                        .attr("cy", function(d,i) { return projection(get_lonlat_pair(d,i))[1];})
                        .attr("r",function(d){ return circle_radius;})
                        .on('mouseover', tip_firestations.show)
                        .on('mouseout', tip_firestations.hide)
                        .attr("class","fire_station_circles");


                    svg.selectAll("text")
                        .data(fire_stations_data)
                        .enter()
                        .append("text")
                        .attr("class","labels")
                        .text(function(d) {
                            return d["station"];
                        })
                        .attr("x", function(d,i) {
                            var bbox = this.getBBox();
                            var thisWidth = bbox.width;
                            return projection(get_lonlat_pair(d,i))[0] - thisWidth/3;
                        })
                        .attr("y", function(d,i) {
                            var bbox = this.getBBox();
                            var thisHeight = bbox.height;
                            return projection(get_lonlat_pair(d,i))[1] - circle_radius - 2.5;
                        })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "10px")
                        .attr("fill", "#8b0000");

            }

            // Create the hourly Histagram for the neighborhoods
            function create_hourly_histogram()
            {
                var hood_data;

                if(neighborhood_chosen_index == -1){
                    //TODO set the data for whole San Francisco here
                    hood_data = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
                }
                else{
                    hood_data = neighborhood_map_data[neighborhood_chosen_index]["response"]["hourly"];
                }

                svg1_histo.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .selectAll("text");

                svg1_histo.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("time (sek)");

                svg1_histo.selectAll(".bar")
                    .data(hood_data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", function(d,i) { return xScale(i); })
                    .attr("width", xScale.rangeBand())
                    .attr("y", function(d) { return yScale(d); })
                    .attr("height", function(d) { return height - yScale(d); })
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide);
            }

            // Update the hourly Histogram with information on hood or year changes
            function update_hourly_histogram()
            {

                var hood_data;

                if(neighborhood_chosen_index == -1){
                    //This means that San Francisco is chosen 
                    var key_sanfran =  "sanfran" +  filter_yearbutton_id(geo_button_year_chosen);
                    hood_data = neighborhood_map_data_overall[key_sanfran]["response"]["hourly"];
                }
                else{
                    hood_data = neighborhood_map_data[neighborhood_chosen_index]["response"]["hourly"];
                }

                //Update all rects
                var bar = svg1_histo.selectAll("rect")
                    .data(hood_data)

                bar.transition()
                    .duration(500)
                    .attr("x", function(d,i) { return xScale(i); })
                    .attr("width", xScale.rangeBand())
                    .attr("y", function(d) { return yScale(d); })
                    .attr("height", function(d) { return height - yScale(d); })
            }

            // Update the stack histogram when information on hood or year changes
            function update_stack_histogram (){

                // First we need to extract the correct data
                var hood_data_stack;

                if(neighborhood_chosen_index == -1){
                    //This means that San Francisco is chosen 
                    var key_sanfran =  "sanfran" +  filter_yearbutton_id(geo_button_year_chosen);
                    hood_data_stack = neighborhood_map_data_overall[key_sanfran];
                }
                else{
                    hood_data_stack = neighborhood_map_data[neighborhood_chosen_index];
                }

                var ABC = [
                    1 - hood_data_stack['late-ratio'],
                    hood_data_stack['late-ratio'] - hood_data_stack['verylate-ratio'],
                    hood_data_stack['verylate-ratio']
                ];

                var data_stack_update = [
                    {steps: 'Response time', A: ABC[0], B: ABC[1], C: ABC[2]},
                ];
             
                var dataIntermediate_update = xData.map(function (c) {
                    return data_stack_update.map(function (d) {
                        return {x: d.steps, y: d[c]};
                    });
                });
                 
                var dataStackLayout_update = d3.layout.stack()(dataIntermediate_update);
                 
                x_stack.domain(dataStackLayout_update[0].map(function (d) {
                    return d.x;
                }));
                 
                y_stack.domain([0,
                    d3.max(dataStackLayout_update[dataStackLayout_update.length - 1],
                            function (d) { return d.y0 + d.y;})
                    ])
                  .nice();

                var layer = svg_stack.selectAll(".stack")
                    .data(dataStackLayout_update);

                layer.selectAll("rect")
                    .data(function (d) {
                        return d;
                    })
                    .transition()
                    .duration(500)
                    .attr("y", function (d) {
                        return y_stack(d.y + d.y0);
                    })
                    .attr("height", function (d) {
                        return y_stack(d.y0) - y_stack(d.y + d.y0);
                    })
                    .attr("width", x_stack.rangeBand());

                svg_stack.selectAll("text")
                    .filter(".stack-layout-text")
                    .data(dataStackLayout_update)
                    .transition()
                    .duration(500)
                    .text(function(d,i) {
                        var total_percentage;
                        if(i==0){
                            total_percentage = data_stack_update[0]["A"];
                        }
                        else{
                            total_percentage = data_stack_update[0]["A"] + data_stack_update[0]["B"];
                        }
                        return "--" + Math.round(total_percentage * 100) + "%";
                    })
                    .attr("y", function(d,i) {
                        var text_y = y_stack(d[0].y0 + d[0].y) 
                        return text_y;
                    })
            };


            function update_data(){
                var key = "combined" +  filter_yearbutton_id(geo_button_year_chosen);
                neighborhood_map_data = neighborhood_map_data_overall[key];
            }

            function update_neighborhood(index){
                neighborhood_chosen_index = index;
                if(index > -1){
                    document.getElementById('h2_neighborhood').innerHTML = neighborhood_map_data[neighborhood_chosen_index]["hood"];
                }
                else{
                    document.getElementById('h2_neighborhood').innerHTML = "San Francisco";
                }
            }

            // Get color for an district based on corresponding average respond time
            function getColor_district(index){
                if(geo_button_chosen == "geo_button1"){
                    var respondtime = Math.round(neighborhood_map_data[index]["response"]["avg"]);
                    if(respondtime >= 480){
                        return map_color[3];
                    }
                    else if (respondtime >= 420 && respondtime < 480){
                        return map_color[2];
                    }
                    else if (respondtime >= 360 && respondtime < 420){
                        return map_color[1];
                    }
                    else {
                        return map_color[0];
                    }
                }
                else if (geo_button_chosen == "geo_button2"){
                    var avg_distance = neighborhood_map_data[index]["distance"]["avg"]*1000;
                    if(avg_distance >= 1500){
                        return map_color[3];
                    }
                    else if (avg_distance >= 1000 && avg_distance < 1500){
                        return map_color[2];
                    }
                    else if (avg_distance >= 500 && avg_distance < 1000){
                        return map_color[1];
                    }
                    else {
                        return map_color[0];
                    }
                }
                else if (geo_button_chosen == "geo_button3"){
                    var late_ratio = neighborhood_map_data[index]["late-ratio"];

                    if(late_ratio >= 0.3){
                        return map_color[3];
                    }
                    else if (late_ratio >= 0.25 && late_ratio < 0.3){
                        return map_color[2];
                    }
                    else if (late_ratio >= 0.2 && late_ratio < 0.25){
                        return map_color[1];
                    }
                    else {
                        return map_color[0];
                    }
                }
                else if (geo_button_chosen == "geo_button4"){
                    var verylate_ratio = neighborhood_map_data[index]["verylate-ratio"];

                    if(verylate_ratio >= 0.1){
                        return map_color[3];
                    }
                    else if (verylate_ratio >= 0.075 && verylate_ratio < 0.1){
                        return map_color[2];
                    }
                    else if (verylate_ratio >= 0.05 && verylate_ratio < 0.075){
                        return map_color[1];
                    }
                    else {
                        return map_color[0];
                    }
                }
                else {
                    return map_color[0];
                }

                // over 10 min 10 * 60 = 600 
                // yfir 9 min 9 * 60 = 540
                // yfir 8 min 8 * 60 = 480
                // undir 8 min 7 * 60 = 420
            }

            function update_scale_txt(){
                var text1;
                var text2;
                var text3;
                var text4;

                if(geo_button_chosen == "geo_button1"){
                    text1 = "Avg. response time >= 8 min";
                    text2 = "7 min =< Avg. response time < 8 min";
                    text3 = "6 min =< Avg. response time < 7 min";
                    text4 = "Avg. response time < 6 min";
                }
                else if (geo_button_chosen == "geo_button2"){
                    text1 = "Avg. distance to firestation >= 1500 m";
                    text2 = "1000 m <= Avg. distance to firestation < 1500 m";
                    text3 = "500 m <= Avg. distance to firestation < 1000 m";
                    text4 = "Avg. distance to firestation < 500 m";
                }
                else if (geo_button_chosen == "geo_button3"){
                    text1 = "Ratio of late responses >= 10%";
                    text2 = "7,5% <= Ratio of late responses < 10%";
                    text3 = "5% <= Ratio of late respones < 7,5%";
                    text4 = "Ratio of late responses < 5%";
                }
                else if (geo_button_chosen == "geo_button4"){
                    text1 = "Ratio of critically late responses >= 10%";
                    text2 = "7,5% <= Ratio of critically late responses < 10%";
                    text3 = "5% <= Ratio of critically late respones < 7,5%";
                    text4 = "Ratio of critically late responses < 5%";
                }
                else {
                    text1 = "";
                    text2 = "";
                    text3 = "";
                    text4 = "";
                }

                document.getElementById('scale_text1').innerHTML = text1; 
                document.getElementById('scale_text2').innerHTML = text2; 
                document.getElementById('scale_text3').innerHTML = text3; 
                document.getElementById('scale_text4').innerHTML = text4; 
            }

            // sort an array by dictionary key
            function sortByKey(array, key) {
                return array.sort(function(a, b) {
                    var x = a[key];
                    var y = b[key];

                    if (typeof x == "string"){
                        x = x.toLowerCase(); 
                    }
                    if (typeof y == "string"){
                        y = y.toLowerCase();
                    }

                    return ((x < y) ? -1 : ((x > y) ? 1 : 0));
                });
            }

            // Change seconds to minutes and seconds
            function minutes_from_seconds(time){
                time = Math.round(time);
                var minutes = Math.floor(time / 60);
                var seconds = Math.round(time - minutes * 60);

                return minutes + " min " + seconds + " seconds";
            }

            function getPercentage(n){
                return Math.round(n * 100 * 100)/100;
            }

            function getMetersFromKm(n){
                return Math.round(n * 1000);
            }

            // returns addition info for the neighborhood district
            function get_additional_info_for_neighborhood(d,i){
                var additional_info_html = "<div style='margin: 0px 0px 15px 0px; text-align:center';><strong style='margin-right: 6px'>" + neighborhoods_statistic[i]['neighborhood'] + "</strong></div>"

                        + "<div style='margin-bottom: 6px '><span class='tipperCol' >" + "Average response time:" + "</span></strong> <span style='color:"+ secondaryColor + "'>" + minutes_from_seconds(neighborhood_map_data[i]["response"]["avg"]) + "</div>"

                        + "<div style='margin-bottom: 6px '><span class='tipperCol' >" + "Average distance to responding fire station:" + "</span></strong> <span style='color:"+ secondaryColor + "'>" + getMetersFromKm(neighborhood_map_data[i]["distance"]["avg"]) + " meters" +"</div>"

                        + "<div style='margin-bottom: 6px '><span class='tipperCol' >" + "Ratio of late response time:" + "</span></strong> <span style='color:"+ secondaryColor + "'>"  + getPercentage(neighborhood_map_data[i]["late-ratio"]) + "%" + "</div>"

                        + "<div style='margin-bottom: 15px '><span class='tipperCol' >" + "Ratio of critically late response time:" + "</span></strong> <span style='color:"+ secondaryColor + "'>"  + getPercentage(neighborhood_map_data[i]["verylate-ratio"]) + "%" + "</div>"

                        + "<div style='margin-bottom: 10px'><strong style='margin-right: 6px'>" + "Additional info:" + "</strong></div>";


                    if(neighborhoods_statistic[i]['neighborhood'] == "Lincoln Park" || neighborhoods_statistic[i]['neighborhood'] == "McLaren Park"){
                        return additional_info_html + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "This is just a park so there is no additional info to see here" + "</span></strong> </div>";
                    }
                    else {
                        return additional_info_html
                        
                        + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "Population:" + "</span></strong> <span style='color:rgba(255,255,255,0.9)'>" + neighborhoods_statistic[i]['total_population'] + " inhabitants" + "</span>  </div>"

                        + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "Population density:" + "</span></strong> <span style='color:rgba(255,255,255,0.9)'>" + neighborhoods_statistic[i]['people_density'] + " per square mile"  + "</span>  </div>"

                        + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "Area:" + "</span></strong> <span style='color:rgba(255,255,255,0.9)'>" + neighborhoods_statistic[i]['area'] + " square miles" + "</span>  </div>"

                        + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "Median household income:" + "</span></strong> <span style='color:rgba(255,255,255,0.9)'>" + "$ "+ neighborhoods_statistic[i]['household_income'] + "</span> <span class='tipperCol' >" + "</span>   </div>"

                        + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "ratio of people below poverty level:" + "</span></strong> <span style='color:rgba(255,255,255,0.9)'>" + getPercentage(Number(neighborhoods_statistic[i]['poverty_level'])) + "%" + "</span> <span class='tipperCol' >" + "</span>   </div>"

                        + "<div style='margin-bottom: 6px'><span class='tipperCol' >" + "ratio of foreign born residents:" + "</span></strong> <span style='color:rgba(255,255,255,0.9)'>" + getPercentage(neighborhoods_statistic[i]['foreign_born_residents']) + "%" + "</span> <span class='tipperCol' >" + "</span>   </div>";
                    }
            }

            // Sets the text color of each p as black except the chosen model
            function setcolor_button(chosen_button, button_cluster) {
                button_cluster = ".button_geo" + button_cluster;

                d3.selectAll("button")
                    .filter(button_cluster)
                    .style("color", "black");

                d3.selectAll("button")
                    .filter("#"+chosen_button)
                    .style("color", primaryColor);
            }

            function filter_yearbutton_id(id){
                if(id == "y2012"){
                    return "2012";
                }
                if(id == "y2013"){
                    return "2013";
                }
                if(id == "y2014"){
                    return "2014";
                }
                if(id == "y2015"){
                    return "2015";
                }
                if(id == "y2016"){
                    return "2016";
                }
                else{
                    return "overall"
                }
            }
            
        </script>

    </body>
</html>